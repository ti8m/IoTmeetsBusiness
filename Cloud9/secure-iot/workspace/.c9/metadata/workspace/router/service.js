{"changed":true,"filter":false,"title":"service.js","tooltip":"/router/service.js","value":"var express = require('express');\nvar Device = require('../models/device');\nvar jwt = require('jsonwebtoken');\n\nmodule.exports = function(app) {\n\n  // get an instance of the router for api routes\n  var serviceRoutes = express.Router();\n\n\n  // ========================================\n  // Route middleware to verify a token =====\n  // ========================================\n\n  serviceRoutes.use(function(req, res, next) {\n\n    // check header or url parameters or post parameters for token\n    var token = req.body.token || req.query.token || req.headers['x-access-token'];\n\n    // decode token\n    if (token) {\n\n      // verify secret and check exp\n      jwt.verify(token, app.get('token-secret'), function(err, decoded) {\n        if (err) {\n          \n          return res.status(403).send({\n            success: false,\n            message: 'Invalid token'\n          });\n          \n        } else {\n            // save to request for use in other routes\n            req.decoded = decoded;\n            next();\n        }\n        \n      });\n\n    }\n    else {\n      \n      return res.status(403).send({\n        success: false,\n        message: 'No token provided.'\n      });\n\n    }\n  });\n\n\n\n  // ==========================================\n  // Service Data-Route (need a token) ========\n  // ==========================================\n  serviceRoutes.post('/data', function(req, res) {\n    \n    // var deviceId = \"1234\";\n    var deviceId = req.body.deviceId;\n    var timestamp = new Date(); // UTC time\n\n    // find device by id\n    Device.findOne({deviceId: deviceId}, function(err, device) {\n          if (err) throw err;\n          \n          if(device) {\n            \n            console.log(\"Save data from device \" + deviceId);\n            console.log(req.body.temp + \"Â°C\");\n            console.log(req.body.humid + \"%\");\n            console.log(timestamp);\n            \n            var data = {\n              temp: req.body.temp,\n              humid: req.body.humid,\n              timestamp: timestamp\n            };\n            \n            device.data.push(data);\n            \n            device.save(function(err) {\n              if (err) throw err;\n              console.log('Data saved successfully');\n              \n              return res.status(201).send({\n              success: true,\n              message: 'New data saved'\n              });\n            \n            });\n            \n          } else {\n              console.log(\"Device not found\");\n            \n              return res.status(404).send({\n              success: false,\n              message: 'Device not found'\n              });\n            \n          }\n          \n    });\n\n  });\n\n\n  // apply the routes to app with the prefix /service\n  app.use('/service', serviceRoutes);\n\n};","undoManager":{"mark":-2,"position":70,"stack":[[{"start":{"row":52,"column":22},"end":{"row":52,"column":23},"action":"remove","lines":["e"],"id":1}],[{"start":{"row":52,"column":21},"end":{"row":52,"column":22},"action":"remove","lines":["t"],"id":2}],[{"start":{"row":52,"column":20},"end":{"row":52,"column":21},"action":"remove","lines":["u"],"id":3}],[{"start":{"row":52,"column":19},"end":{"row":52,"column":20},"action":"remove","lines":["o"],"id":4}],[{"start":{"row":52,"column":18},"end":{"row":52,"column":19},"action":"remove","lines":["R"],"id":5}],[{"start":{"row":52,"column":17},"end":{"row":52,"column":18},"action":"remove","lines":["-"],"id":6}],[{"start":{"row":52,"column":16},"end":{"row":52,"column":17},"action":"remove","lines":["h"],"id":7}],[{"start":{"row":52,"column":15},"end":{"row":52,"column":16},"action":"remove","lines":["t"],"id":8}],[{"start":{"row":52,"column":14},"end":{"row":52,"column":15},"action":"remove","lines":["u"],"id":9}],[{"start":{"row":52,"column":13},"end":{"row":52,"column":14},"action":"remove","lines":["A"],"id":10}],[{"start":{"row":52,"column":12},"end":{"row":52,"column":13},"action":"remove","lines":[" "],"id":11}],[{"start":{"row":52,"column":12},"end":{"row":52,"column":13},"action":"insert","lines":["-"],"id":12}],[{"start":{"row":52,"column":13},"end":{"row":52,"column":14},"action":"insert","lines":["D"],"id":13}],[{"start":{"row":52,"column":14},"end":{"row":52,"column":15},"action":"insert","lines":["a"],"id":14}],[{"start":{"row":52,"column":15},"end":{"row":52,"column":16},"action":"insert","lines":["t"],"id":15}],[{"start":{"row":52,"column":16},"end":{"row":52,"column":17},"action":"insert","lines":["a"],"id":16}],[{"start":{"row":52,"column":17},"end":{"row":52,"column":18},"action":"insert","lines":[" "],"id":17}],[{"start":{"row":52,"column":18},"end":{"row":52,"column":19},"action":"insert","lines":["R"],"id":18}],[{"start":{"row":52,"column":19},"end":{"row":52,"column":20},"action":"insert","lines":["o"],"id":19}],[{"start":{"row":52,"column":20},"end":{"row":52,"column":21},"action":"insert","lines":["u"],"id":20}],[{"start":{"row":52,"column":21},"end":{"row":52,"column":22},"action":"insert","lines":["t"],"id":21}],[{"start":{"row":52,"column":22},"end":{"row":52,"column":23},"action":"insert","lines":["e"],"id":22}],[{"start":{"row":52,"column":12},"end":{"row":52,"column":13},"action":"remove","lines":["-"],"id":23}],[{"start":{"row":52,"column":12},"end":{"row":52,"column":13},"action":"insert","lines":[" "],"id":24}],[{"start":{"row":52,"column":17},"end":{"row":52,"column":18},"action":"remove","lines":[" "],"id":25}],[{"start":{"row":52,"column":17},"end":{"row":52,"column":18},"action":"insert","lines":["-"],"id":26}],[{"start":{"row":53,"column":47},"end":{"row":54,"column":0},"action":"remove","lines":["",""],"id":27}],[{"start":{"row":91,"column":12},"end":{"row":91,"column":14},"action":"insert","lines":["  "],"id":28}],[{"start":{"row":93,"column":12},"end":{"row":93,"column":14},"action":"insert","lines":["  "],"id":29}],[{"start":{"row":94,"column":12},"end":{"row":94,"column":14},"action":"insert","lines":["  "],"id":30}],[{"start":{"row":95,"column":12},"end":{"row":95,"column":14},"action":"insert","lines":["  "],"id":31}],[{"start":{"row":96,"column":12},"end":{"row":96,"column":14},"action":"insert","lines":["  "],"id":32}],[{"start":{"row":24,"column":18},"end":{"row":25,"column":0},"action":"insert","lines":["",""],"id":33},{"start":{"row":25,"column":0},"end":{"row":25,"column":10},"action":"insert","lines":["          "]}],[{"start":{"row":33,"column":35},"end":{"row":33,"column":36},"action":"remove","lines":[" "],"id":34}],[{"start":{"row":33,"column":34},"end":{"row":33,"column":35},"action":"remove","lines":[","],"id":35}],[{"start":{"row":33,"column":33},"end":{"row":33,"column":34},"action":"remove","lines":["d"],"id":36}],[{"start":{"row":33,"column":32},"end":{"row":33,"column":33},"action":"remove","lines":["o"],"id":37}],[{"start":{"row":33,"column":31},"end":{"row":33,"column":32},"action":"remove","lines":["o"],"id":38}],[{"start":{"row":33,"column":30},"end":{"row":33,"column":31},"action":"remove","lines":["g"],"id":39}],[{"start":{"row":33,"column":29},"end":{"row":33,"column":30},"action":"remove","lines":[" "],"id":40}],[{"start":{"row":33,"column":28},"end":{"row":33,"column":29},"action":"remove","lines":["s"],"id":41}],[{"start":{"row":33,"column":27},"end":{"row":33,"column":28},"action":"remove","lines":["i"],"id":42}],[{"start":{"row":33,"column":26},"end":{"row":33,"column":27},"action":"remove","lines":[" "],"id":43}],[{"start":{"row":33,"column":25},"end":{"row":33,"column":26},"action":"remove","lines":["g"],"id":44}],[{"start":{"row":33,"column":24},"end":{"row":33,"column":25},"action":"remove","lines":["n"],"id":45}],[{"start":{"row":33,"column":23},"end":{"row":33,"column":24},"action":"remove","lines":["i"],"id":46}],[{"start":{"row":33,"column":22},"end":{"row":33,"column":23},"action":"remove","lines":["h"],"id":47}],[{"start":{"row":33,"column":21},"end":{"row":33,"column":22},"action":"remove","lines":["t"],"id":48}],[{"start":{"row":33,"column":20},"end":{"row":33,"column":21},"action":"remove","lines":["y"],"id":49}],[{"start":{"row":33,"column":19},"end":{"row":33,"column":20},"action":"remove","lines":["r"],"id":50}],[{"start":{"row":33,"column":18},"end":{"row":33,"column":19},"action":"remove","lines":["e"],"id":51}],[{"start":{"row":33,"column":17},"end":{"row":33,"column":18},"action":"remove","lines":["v"],"id":52}],[{"start":{"row":33,"column":16},"end":{"row":33,"column":17},"action":"remove","lines":["e"],"id":53}],[{"start":{"row":33,"column":15},"end":{"row":33,"column":16},"action":"remove","lines":[" "],"id":54}],[{"start":{"row":33,"column":14},"end":{"row":33,"column":15},"action":"remove","lines":["f"],"id":55}],[{"start":{"row":33,"column":13},"end":{"row":33,"column":14},"action":"remove","lines":["i"],"id":56}],[{"start":{"row":36,"column":9},"end":{"row":37,"column":0},"action":"insert","lines":["",""],"id":57},{"start":{"row":37,"column":0},"end":{"row":37,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":32,"column":6},"end":{"row":32,"column":8},"action":"remove","lines":["  "],"id":58}],[{"start":{"row":32,"column":4},"end":{"row":32,"column":6},"action":"remove","lines":["  "],"id":59}],[{"start":{"row":32,"column":2},"end":{"row":32,"column":4},"action":"remove","lines":["  "],"id":60}],[{"start":{"row":32,"column":0},"end":{"row":32,"column":2},"action":"remove","lines":["  "],"id":61}],[{"start":{"row":31,"column":9},"end":{"row":32,"column":0},"action":"remove","lines":["",""],"id":62}],[{"start":{"row":31,"column":9},"end":{"row":31,"column":10},"action":"insert","lines":[" "],"id":63}],[{"start":{"row":32,"column":10},"end":{"row":32,"column":12},"action":"insert","lines":["  "],"id":64}],[{"start":{"row":33,"column":10},"end":{"row":33,"column":12},"action":"insert","lines":["  "],"id":65}],[{"start":{"row":34,"column":10},"end":{"row":34,"column":12},"action":"insert","lines":["  "],"id":66}],[{"start":{"row":22,"column":16},"end":{"row":22,"column":17},"action":"remove","lines":["s"],"id":67}],[{"start":{"row":22,"column":15},"end":{"row":22,"column":16},"action":"remove","lines":["e"],"id":68}],[{"start":{"row":22,"column":14},"end":{"row":22,"column":15},"action":"remove","lines":["i"],"id":69}],[{"start":{"row":22,"column":9},"end":{"row":22,"column":14},"action":"remove","lines":["verif"],"id":70},{"start":{"row":22,"column":9},"end":{"row":22,"column":15},"action":"insert","lines":["verify"]}],[{"start":{"row":22,"column":32},"end":{"row":22,"column":33},"action":"remove","lines":["s"],"id":71}]]},"ace":{"folds":[],"customSyntax":"javascript","scrolltop":0,"scrollleft":0,"selection":{"start":{"row":31,"column":16},"end":{"row":31,"column":16},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1464702046000}